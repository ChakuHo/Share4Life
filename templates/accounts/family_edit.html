{% extends "master/base.html" %}
{% block content %}

<section class="section-content padding-y" style="min-height:84vh;">
  <div class="container" style="max-width: 900px;">

    <div class="d-flex justify-content-between align-items-center mb-3">
      <div>
        <h3 class="mb-1">Edit Family Member</h3>
        <div class="text-muted">Update emergency profile settings and details.</div>
      </div>

      <div class="d-flex align-items-center" style="gap:.5rem;">
        <a href="{% url 'profile' %}" class="btn btn-outline-secondary">
          <i class="fa fa-arrow-left"></i> Back
        </a>

        <form method="post"
              action="{% url 'family_delete' fm.id %}"
              class="m-0"
              onsubmit="return confirm('Delete {{ fm.name|escapejs }}? This cannot be undone.');">
          {% csrf_token %}
          <button type="submit" class="btn btn-outline-danger" id="del-btn">
            <i class="fa fa-trash"></i> Delete
          </button>
        </form>
      </div>
    </div>

    <div class="card shadow-sm">
      <div class="card-body">

        <form method="post" novalidate id="family-form">
          {% csrf_token %}

          {% if form.non_field_errors %}
            <div class="alert alert-danger">{{ form.non_field_errors }}</div>
          {% endif %}

          <h5 class="mb-3"><i class="fa fa-users text-primary"></i> Basic Info</h5>

          <div class="form-row">
            <div class="form-group col-md-5">
              <label class="font-weight-bold">Name</label>
              {{ form.name }}
              {% for e in form.name.errors %}<div class="text-danger small">{{ e }}</div>{% endfor %}
            </div>

            <div class="form-group col-md-4">
              <label class="font-weight-bold">Relationship</label>
              {{ form.relationship }}
              {% for e in form.relationship.errors %}<div class="text-danger small">{{ e }}</div>{% endfor %}
            </div>

            <div class="form-group col-md-3">
              <label class="font-weight-bold">Phone (optional)</label>
              {{ form.phone_number }}
              {% for e in form.phone_number.errors %}<div class="text-danger small">{{ e }}</div>{% endfor %}
            </div>
          </div>

          <hr>

          <h5 class="mb-2"><i class="fa fa-ambulance text-danger"></i> Emergency Profile</h5>
          <div class="text-muted small mb-3">
            Emergency profiles can be used for one-click prefilled blood requests.
          </div>

          <div class="custom-control custom-checkbox mb-3">
            {{ form.is_emergency_profile }}
            <label class="custom-control-label" for="{{ form.is_emergency_profile.id_for_label }}">
              <b>Mark as Emergency Profile</b>
            </label>
            {% for e in form.is_emergency_profile.errors %}<div class="text-danger small">{{ e }}</div>{% endfor %}
          </div>

          <div id="emergencyFields" style="display:none;">
            <div class="alert alert-light" style="border-radius:12px;">
              <b>Emergency profile details</b> (required: Blood group + City)
            </div>

            <div class="form-row">
              <div class="form-group col-md-4">
                <label class="font-weight-bold">Blood group</label>
                {{ form.blood_group }}
                {% for e in form.blood_group.errors %}<div class="text-danger small">{{ e }}</div>{% endfor %}
              </div>

              <div class="form-group col-md-4">
                <label class="font-weight-bold">City</label>
                {{ form.city }}
                {% for e in form.city.errors %}<div class="text-danger small">{{ e }}</div>{% endfor %}
              </div>

              <div class="form-group col-md-4">
                <label class="font-weight-bold">Date of birth (optional)</label>
                {{ form.date_of_birth }}
                {% for e in form.date_of_birth.errors %}<div class="text-danger small">{{ e }}</div>{% endfor %}
              </div>
            </div>

            <div class="form-group">
              <label class="font-weight-bold">Medical history (optional)</label>
              {{ form.medical_history }}
              {% for e in form.medical_history.errors %}<div class="text-danger small">{{ e }}</div>{% endfor %}
            </div>

            <div class="form-row">
              <div class="form-group col-md-6">
                <label class="font-weight-bold">Latitude (optional)</label>
                {{ form.latitude }}
                {% for e in form.latitude.errors %}<div class="text-danger small">{{ e }}</div>{% endfor %}
              </div>
              <div class="form-group col-md-6">
                <label class="font-weight-bold">Longitude (optional)</label>
                {{ form.longitude }}
                {% for e in form.longitude.errors %}<div class="text-danger small">{{ e }}</div>{% endfor %}
              </div>
            </div>
          </div>

          <button class="btn btn-primary btn-lg btn-block" type="submit" id="save-btn">
            <i class="fa fa-save"></i> Save Changes
          </button>

        </form>

      </div>
    </div>

  </div>
</section>

<script>
document.addEventListener("DOMContentLoaded", function(){
  const chk = document.getElementById("{{ form.is_emergency_profile.id_for_label }}");
  const block = document.getElementById("emergencyFields");
  const btn = document.getElementById("save-btn");
  const form = document.getElementById("family-form");

  function sync(){
    if (!chk || !block) return;
    block.style.display = chk.checked ? "block" : "none";
  }
  sync();
  if (chk) chk.addEventListener("change", sync);

  if (btn && form){
    form.addEventListener("submit", function(){
      btn.disabled = true;
      btn.innerHTML = '<i class="fa fa-spinner fa-spin"></i> Saving...';
    });
  }
});
</script>

{% endblock %}