{% extends "master/base.html" %}
{% block content %}

<section class="section-content padding-y" style="min-height:84vh;">
  <div class="container">

    <!-- Header -->
    <div class="d-flex flex-wrap justify-content-between align-items-center mb-3">
      <div>
        <h3 class="mb-1">Institution Portal</h3>
        <div class="text-muted">
          {{ org.name }} • {{ org.get_org_type_display }}{% if org.city %} • {{ org.city }}{% endif %}
        </div>
      </div>

      <div class="mt-2 mt-md-0">
        <a href="{% url 'org_members' %}" class="btn btn-outline-secondary">
          <i class="fa fa-users"></i> Members
        </a>
        <a href="{% url 'org_campaign_list' %}" class="btn btn-outline-primary ml-2">
          <i class="fa fa-calendar"></i> Campaigns
        </a>
      </div>
    </div>

    <div class="row">

      <!-- Pending Requests -->
      <div class="col-lg-7 mb-4">
        <div class="card shadow-sm h-100">
          <div class="card-body">
            <h5 class="mb-3">
              <i class="fa fa-clipboard-check text-primary"></i> Pending Blood Requests
            </h5>

            {% for r in pending_requests %}
              <div class="border rounded p-3 mb-2">

                <div class="d-flex flex-wrap justify-content-between align-items-start">
                  <div class="pr-3">
                    <div class="d-flex flex-wrap align-items-center mb-1">
                      <strong class="mr-2">{{ r.patient_name }}</strong>

                      {% if r.is_emergency %}
                        <span class="badge badge-danger p-2 mr-2 mb-1">EMERGENCY</span>
                      {% endif %}

                      {% if r.verification_status == "VERIFIED" %}
                        <span class="badge badge-success p-2 mr-2 mb-1">VERIFIED</span>
                      {% elif r.verification_status == "PENDING" %}
                        <span class="badge badge-warning p-2 mr-2 mb-1">PENDING</span>
                      {% elif r.verification_status == "REJECTED" %}
                        <span class="badge badge-danger p-2 mr-2 mb-1">REJECTED</span>
                      {% else %}
                        <span class="badge badge-secondary p-2 mr-2 mb-1">{{ r.verification_status }}</span>
                      {% endif %}

                      <span class="badge badge-primary p-2 mb-1">{{ r.get_status_display }}</span>
                    </div>

                    <div class="text-muted small">
                      Blood: <strong>{{ r.blood_group }}</strong>
                      • Units: <strong>{{ r.units_needed }}</strong><br>
                      Hospital: {{ r.hospital_name }} • City: {{ r.location_city }}<br>
                      Contact: {{ r.contact_phone }}
                    </div>
                  </div>

                  <div class="mt-2 mt-md-0 text-md-right">
                    <a class="btn btn-sm btn-outline-primary mb-2"
                       href="{% url 'blood_request_detail' r.id %}">
                      View
                    </a>

                    {% if r.proof_document %}
                      <a class="btn btn-sm btn-outline-secondary mb-2" target="_blank"
                         href="{% url 'blood_request_proof' r.id %}">
                        View Proof
                      </a>
                    {% endif %}
                  </div>
                </div>

                <!-- Actions -->
                <div class="mt-3">

                  <!-- Approve -->
                  <form method="post" action="{% url 'org_verify_request' r.id %}" class="d-inline-block mr-2 mb-2">
                    {% csrf_token %}
                    <button class="btn btn-success btn-sm" type="submit" name="action" value="approve">
                      <i class="fa fa-check"></i> Approve
                    </button>
                  </form>

                  <!-- Reject -->
                  <form method="post" action="{% url 'org_verify_request' r.id %}" class="d-inline-block mb-2">
                    {% csrf_token %}
                    <div class="d-flex flex-wrap align-items-center">
                      <input type="text"
                             name="reason"
                             class="form-control form-control-sm mr-2 mb-2"
                             style="width: 260px;"
                             placeholder="Reject reason (optional)">
                      <button class="btn btn-danger btn-sm mb-2" type="submit" name="action" value="reject">
                        <i class="fa fa-times"></i> Reject
                      </button>
                    </div>
                  </form>

                </div>

              </div>
            {% empty %}
              <div class="text-muted">No pending requests.</div>
            {% endfor %}
          </div>
        </div>
      </div>

      <!-- Pending Donations -->
      <div class="col-lg-5 mb-4">
        <div class="card shadow-sm h-100">
          <div class="card-body">
            <h5 class="mb-3">
              <i class="fa fa-history text-primary"></i> Pending Donation Verification
            </h5>

            {% for d in pending_donations %}
              <div class="border rounded p-3 mb-2">
                <div class="d-flex justify-content-between align-items-start">
                  <div>
                    <strong>
                      Donor:
                      {% if d.donor_user %}
                        {{ d.donor_user.username }}
                      {% else %}
                        —
                      {% endif %}
                    </strong>
                    <div class="text-muted small">
                      Date: {{ d.donated_at|date:"Y-m-d H:i" }}<br>
                      Units: {{ d.units }} • Hospital: {{ d.hospital_name|default:d.request.hospital_name }}
                    </div>
                  </div>

                  <span class="badge badge-secondary p-2">{{ d.status }}</span>
                </div>

                <div class="mt-2 d-flex flex-wrap align-items-center">
                  {% if d.request %}
                    <a class="btn btn-sm btn-outline-primary mr-2 mb-2"
                       href="{% url 'blood_request_detail' d.request.id %}">
                      View Request
                    </a>
                  {% endif %}

                  <form method="post" action="{% url 'org_verify_donation' d.id %}" class="mb-2">
                    {% csrf_token %}
                    <button class="btn btn-sm btn-success" type="submit">
                      <i class="fa fa-check"></i> Verify Donation
                    </button>
                  </form>
                </div>
              </div>
            {% empty %}
              <div class="text-muted">No donations pending verification.</div>
            {% endfor %}
          </div>
        </div>
      </div>

    </div>

  </div>
</section>

{% endblock %}