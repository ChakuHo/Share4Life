{% if messages %}
<div id="messages-container" class="messages-container">

  {% if messages|length > 2 %}
    <div class="text-right mb-2">
      <button type="button"
              class="btn btn-sm btn-outline-danger clear-all-messages"
              id="clearAllBtn"
              onclick="clearAllMessages()">
        <i class="fa fa-trash mr-1"></i>Clear All ({{ messages|length }})
      </button>
    </div>
  {% endif %}

  {% for message in messages %}

    {% if "error" in message.tags or "danger" in message.tags %}
      <div class="alert alert-danger alert-dismissible fade show message-item"
           role="alert" data-autodismiss="0">
        <i class="fa fa-exclamation-triangle mr-2"></i>
        <span class="message-text">{{ message }}</span>
        <button type="button" class="close" data-dismiss="alert" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
        <div class="message-timer" style="display:none;"><div class="timer-bar"></div></div>
      </div>

    {% elif "success" in message.tags %}
      <div class="alert alert-success alert-dismissible fade show message-item"
           role="alert" data-autodismiss="1">
        <i class="fa fa-check-circle mr-2"></i>
        <span class="message-text">{{ message }}</span>
        <button type="button" class="close" data-dismiss="alert" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
        <div class="message-timer" style="display:none;"><div class="timer-bar"></div></div>
      </div>

    {% elif "warning" in message.tags %}
      <div class="alert alert-warning alert-dismissible fade show message-item"
           role="alert" data-autodismiss="1">
        <i class="fa fa-exclamation-circle mr-2"></i>
        <span class="message-text">{{ message }}</span>
        <button type="button" class="close" data-dismiss="alert" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
        <div class="message-timer" style="display:none;"><div class="timer-bar"></div></div>
      </div>

    {% else %}
      <div class="alert alert-info alert-dismissible fade show message-item"
           role="alert" data-autodismiss="1">
        <i class="fa fa-info-circle mr-2"></i>
        <span class="message-text">{{ message }}</span>
        <button type="button" class="close" data-dismiss="alert" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
        <div class="message-timer" style="display:none;"><div class="timer-bar"></div></div>
      </div>
    {% endif %}

  {% endfor %}
</div>

<style>
.messages-container {
  position: fixed;
  right: 20px;
  top: var(--s4l-toast-top, 100px);
  width: 350px;
  z-index: 9999;
}

.message-item {
  position: relative;
  box-shadow: 0 4px 12px rgba(0,0,0,0.15);
  border: none;
  animation: slideIn 0.3s ease-out;
  overflow: hidden;
}

/* makes manual fade look smooth even when we remove elements */
.message-item.fade { transition: opacity .22s ease, transform .22s ease; }
.message-item.fading-out { opacity: 0; transform: translateX(8px); }

.messages-container.fade-out { transition: opacity .22s ease; }
.messages-container.fading-out { opacity: 0; }

.message-timer {
  position: absolute;
  bottom: 0; left: 0; right: 0;
  height: 3px;
  background: rgba(255,255,255,0.28);
}
.timer-bar {
  height: 100%;
  background: rgba(255,255,255,0.85);
  width: 0%;
}

@keyframes slideIn {
  from { transform: translateX(100%); opacity: 0; }
  to { transform: translateX(0); opacity: 1; }
}

.alert-success { background: linear-gradient(45deg, #28a745, #218838); color: white; }
.alert-danger  { background: linear-gradient(45deg, #dc3545, #c82333); color: white; }
.alert-warning { background: linear-gradient(45deg, #ffc107, #e0a800); color: #1f2d3d; }
.alert-info    { background: linear-gradient(45deg, #0a2558, #061838); color: white; }

.alert-warning .close { color: #1f2d3d; opacity: 0.9; }
.alert-warning .close:hover { opacity: 1; }
</style>

<script>
(function () {
  function computeToastTop() {
    const topbar = document.querySelector('.s4l-topbar');
    const navbar = document.querySelector('.s4l-navbar');

    const topbarH = topbar ? topbar.getBoundingClientRect().height : 0;
    const navbarH = navbar ? navbar.getBoundingClientRect().height : 0;

    const top = Math.round(topbarH + navbarH + 12);
    document.documentElement.style.setProperty('--s4l-toast-top', top + 'px');
  }

  function fadeRemove(el, ms){
    ms = ms || 220;
    if (!el) return;
    el.classList.add("fade");
    // next tick so transition applies
    setTimeout(function(){
      el.classList.add("fading-out");
    }, 10);
    setTimeout(function(){
      try { el.remove(); } catch(e) {}
    }, ms + 30);
  }

  document.addEventListener('DOMContentLoaded', function() {
    computeToastTop();
    window.addEventListener('resize', computeToastTop);

    document.querySelectorAll('.message-item').forEach((message) => {
      const auto = message.getAttribute('data-autodismiss') === '1';
      if (!auto) return;

      const timer = message.querySelector('.message-timer');
      const timerBar = message.querySelector('.timer-bar');
      if (!timer || !timerBar) return;

      timer.style.display = 'block';
      timerBar.style.transition = 'width 5s linear';
      setTimeout(() => { timerBar.style.width = '100%'; }, 100);

      setTimeout(() => { fadeRemove(message, 220); }, 5000);
    });
  });

  window.clearAllMessages = function () {
    const container = document.getElementById("messages-container");
    const btn = document.getElementById("clearAllBtn");

    if (btn) {
      btn.disabled = true;
      btn.style.opacity = "0.7";
      btn.innerHTML = '<i class="fa fa-spinner fa-spin mr-1"></i>Clearing...';
    }

    // fade each message
    document.querySelectorAll('.message-item').forEach(el => fadeRemove(el, 220));

    // fade container then remove
    if (container) {
      container.classList.add("fade-out");
      setTimeout(function(){
        container.classList.add("fading-out");
      }, 10);
      setTimeout(function(){
        try { container.remove(); } catch(e) {}
      }, 260);
    }
  };
})();
</script>
{% endif %}