{% load static %}

{% url 'home' as home_url %}
{% url 'login' as login_url %}
{% url 'register' as register_url %}
{% url 'logout' as logout_url %}
{% url 'dashboard' as dashboard_url %}
{% url 'profile' as profile_url %}
{% url 'profile_edit' as profile_edit_url %}
{% url 'kyc_submit' as kyc_submit_url %}
{% url 'family_add' as family_add_url %}

{# Blood links #}
{% url 'public_dashboard' as blood_feed_url %}
{% url 'emergency_request' as emergency_request_url %}
{% url 'recipient_request' as recipient_request_url %}
{% url 'donor_history' as donor_history_url %}
{% url 'my_blood_requests' as my_requests_url %}
{% url 'blood_campaigns' as blood_campaigns_url %}

{# Communication inbox #}
{% url 'inbox' as inbox_url %}

{# Organization (Institutions) links #}
{% url 'institutions_home' as institutions_home_url %}
{% url 'org_register' as org_register_url %}
{% url 'org_portal' as org_portal_url %}
{% url 'org_pending' as org_pending_url %}

{# Organ app links #}
{% url 'organ_pledge_list' as organ_pledge_list_url %}
{% url 'organ_pledge_create' as organ_pledge_create_url %}
{% url 'organ_request_list' as organ_request_list_url %}
{% url 'organ_request_create' as organ_request_create_url %}
{% url 'organ_portal' as organ_portal_url %}

{# Crowdfunding links#}
{% url 'campaign_list' as campaign_list_url %}
{% url 'my_donations' as my_donations_url %}

<!-- TOP BAR (NAVY) -->
<div class="s4l-topbar">
  <div class="container d-flex justify-content-between align-items-center">
    <div class="d-none d-md-flex align-items-center">
      <small class="mr-3">
        <i class="fa fa-globe mr-2"></i>{{ site_settings.site_name|default:"Share4Life" }} Global
      </small>
      <small>
        <i class="fa fa-map-marker-alt mr-2"></i>Connecting Donors Nearby
      </small>
    </div>

    <div class="d-flex align-items-center">
      {% if site_settings and site_settings.contact_phone %}
        <a href="tel:{{ site_settings.contact_phone }}" class="s4l-toplink mr-3">
          <i class="fa fa-phone-alt mr-2"></i>{{ site_settings.contact_phone }}
        </a>
      {% endif %}
      <a href="tel:102" class="s4l-toplink">
        <i class="fa fa-ambulance mr-2"></i>Emergency Helpline: 102
      </a>
    </div>
  </div>
</div>

<!-- MAIN NAV (WHITE) -->
<header class="s4l-navbar shadow-sm bg-white">
  <div class="container">
    <div class="row align-items-center py-2 no-gutters">

      <!-- BRAND -->
      <div class="col-lg-3 col-md-3 col-6">
        <a href="{{ home_url|default:'/' }}" class="d-flex align-items-center text-decoration-none">
          {% if site_settings and site_settings.site_logo %}
            <img src="{{ site_settings.site_logo.url }}"
                 alt="{{ site_settings.site_name|default:'Share4Life' }}"
                 class="s4l-logo">
          {% else %}
            <h3 class="m-0 s4l-brand-text">
              <i class="fa fa-heartbeat text-danger mr-2"></i> Share<span class="text-danger">4</span>Life
            </h3>
          {% endif %}
        </a>
      </div>

      <!-- CENTER NAV -->
      <div class="col-lg-5 d-none d-lg-block text-center s4l-center-col">
        <nav class="nav justify-content-center s4l-menu">
          <a class="nav-link" href="{{ blood_feed_url }}">Find Blood</a>
          <a class="nav-link" href="{{ blood_campaigns_url }}">Donation Camps</a>

          {# Organ link (context-aware) #}
          {% if user.is_authenticated %}
            {% if user.is_donor and organ_pledge_list_url %}
              <a class="nav-link" href="{{ organ_pledge_list_url }}">Organ</a>
            {% elif user.is_recipient and organ_request_list_url %}
              <a class="nav-link" href="{{ organ_request_list_url }}">Organ</a>
            {% elif organ_pledge_create_url %}
              <a class="nav-link" href="{{ organ_pledge_create_url }}">Organ</a>
            {% else %}
              <a class="nav-link" href="#">Organ</a>
            {% endif %}
          {% else %}
            {# Not logged in â†’ send to login #}
            <a class="nav-link" href="{{ login_url }}">Organ</a>
          {% endif %}

          {# Institutions #}
          {% if user.is_authenticated %}
            {% if org_membership %}
              <a class="nav-link" href="{{ org_portal_url }}">Institutions</a>
            {% elif org_application %}
              <a class="nav-link" href="{{ org_pending_url }}">Institutions</a>
            {% else %}
              <a class="nav-link" href="{{ org_register_url }}">Institutions</a>
            {% endif %}
          {% else %}
            <a class="nav-link" href="{{ institutions_home_url }}">Institutions</a>
          {% endif %}

          <a class="nav-link" href="{{ campaign_list_url|default:'#' }}">Crowdfunding</a>

          {% url 'about' as about_url %}
          <a class="nav-link" href="{{ about_url|default:'#' }}">About</a>
        </nav>
      </div>

      <!-- RIGHT -->
      <div class="col-lg-4 col-md-9 col-6 d-flex justify-content-end align-items-center flex-nowrap s4l-right-col">

        <!-- Request Blood (pulse) -->
        {% if user.is_authenticated and user.is_recipient %}
          <a href="{{ recipient_request_url }}"
             class="btn btn-danger rounded-pill px-3 font-weight-bold d-none d-sm-inline-flex align-items-center s4l-btn-pulse mr-3">
            <i class="fa fa-tint mr-2"></i> Request Blood
          </a>
        {% else %}
          <a href="{{ emergency_request_url }}"
             class="btn btn-danger rounded-pill px-3 font-weight-bold d-none d-sm-inline-flex align-items-center s4l-btn-pulse mr-3">
            <i class="fa fa-tint mr-2"></i> Request Blood
          </a>
        {% endif %}

        {% if user.is_authenticated %}
          <div class="dropdown">
            <a href="#" data-toggle="dropdown"
               class="d-flex align-items-center text-dark text-decoration-none dropdown-toggle s4l-user-toggle">

              {% if user.profile_image %}
                <img src="{{ user.profile_image.url }}" class="s4l-avatar mr-2" alt="Profile">
              {% else %}
                <div class="s4l-avatar-fallback mr-2">
                  <i class="fa fa-user"></i>
                </div>
              {% endif %}

              {% if unread_notifications_count|default:0 %}
                <span class="s4l-notif-dot" title="You have notifications"></span>
              {% endif %}

              <div class="d-none d-md-block text-left" style="line-height: 1.1;">
                <small class="text-muted d-block" style="font-size: 10px;">Welcome</small>
                <span class="font-weight-bold" style="font-size: 13px;">
                  {{ user.first_name|default:user.username }}
                </span>
              </div>
            </a>

            <div class="dropdown-menu dropdown-menu-right shadow border-0 mt-2">

              <a class="dropdown-item" href="{{ blood_feed_url }}">
                <i class="fa fa-tint mr-2 text-primary"></i> Blood Feed
              </a>

              {% if user.is_recipient %}
                <a class="dropdown-item" href="{{ my_requests_url }}">
                  <i class="fa fa-clipboard-list mr-2 text-primary"></i> My Blood Requests
                </a>
              {% endif %}

              {% if user.is_donor %}
                <a class="dropdown-item" href="{{ donor_history_url }}">
                  <i class="fa fa-history mr-2 text-primary"></i> Donation History
                </a>
              {% endif %}

              {% if my_donations_url %}
                <a class="dropdown-item" href="{{ my_donations_url }}">
                  <i class="fa fa-hand-holding-heart mr-2 text-primary"></i> My Contributions
                </a>
              {% endif %}

              {# Organ links #}
              <div class="dropdown-divider"></div>

              {% if organ_pledge_list_url %}
                <a class="dropdown-item" href="{{ organ_pledge_list_url }}">
                  <i class="fa fa-hand-holding-heart mr-2 text-primary"></i> My Organ Pledges
                </a>
              {% endif %}

              {% if organ_request_list_url %}
                <a class="dropdown-item" href="{{ organ_request_list_url }}">
                  <i class="fa fa-file-medical mr-2 text-primary"></i> My Organ Requests
                </a>
              {% endif %}

              {% if org_membership and organ_portal_url %}
                <a class="dropdown-item" href="{{ organ_portal_url }}">
                  <i class="fa fa-shield-alt mr-2 text-primary"></i> Organ Portal
                </a>
              {% endif %}

              {% if inbox_url %}
                <a class="dropdown-item d-flex justify-content-between align-items-center" href="{{ inbox_url }}">
                  <span><i class="fa fa-bell mr-2 text-primary"></i> Notifications</span>
                  {% if unread_notifications_count|default:0 %}
                    <span class="badge badge-danger" style="border-radius:999px; min-width:22px;">
                      {{ unread_notifications_count }}
                    </span>
                  {% endif %}
                </a>
              {% endif %}

              <!-- Institution -->
              <div class="dropdown-divider"></div>

              {% if org_membership %}
                <a class="dropdown-item" href="{{ org_portal_url }}">
                  <i class="fa fa-hospital mr-2 text-primary"></i> Institution Portal
                </a>
              {% elif org_application %}
                <a class="dropdown-item" href="{{ org_pending_url }}">
                  <i class="fa fa-hospital mr-2 text-primary"></i> Organization Status
                </a>
              {% else %}
                <a class="dropdown-item" href="{{ org_register_url }}">
                  <i class="fa fa-hospital mr-2 text-primary"></i> Register Organization
                </a>
              {% endif %}

              <div class="dropdown-divider"></div>

              {% if profile_url %}
                <a class="dropdown-item" href="{{ profile_url }}">
                  <i class="fa fa-user mr-2 text-primary"></i> Profile
                </a>
              {% endif %}
              {% if profile_edit_url %}
                <a class="dropdown-item" href="{{ profile_edit_url }}">
                  <i class="fa fa-user-tag mr-2 text-primary"></i> Roles & Profile
                </a>
              {% endif %}
              {% if dashboard_url %}
                <a class="dropdown-item" href="{{ dashboard_url }}">
                  <i class="fa fa-tachometer-alt mr-2 text-primary"></i> Dashboard
                </a>
              {% endif %}

              {% if kyc_submit_url %}
                <a class="dropdown-item" href="{{ kyc_submit_url }}">
                  <i class="fa fa-id-card mr-2 text-primary"></i> KYC Verification
                  {% if not user.is_verified %}
                    <span class="badge badge-light ml-2">Pending</span>
                  {% else %}
                    <span class="badge badge-primary ml-2">Verified</span>
                  {% endif %}
                </a>
              {% endif %}

              {% if family_add_url %}
                <a class="dropdown-item" href="{{ family_add_url }}">
                  <i class="fa fa-users mr-2 text-primary"></i> Add Family
                </a>
              {% endif %}

              <div class="dropdown-divider"></div>

              {% if logout_url %}
                <a class="dropdown-item text-danger" href="{{ logout_url }}">
                  <i class="fa fa-sign-out-alt mr-2"></i> Logout
                </a>
              {% endif %}
            </div>
          </div>
        {% else %}
          {% if login_url %}
            <a href="{{ login_url }}" class="text-dark font-weight-bold mr-3 text-decoration-none" style="white-space:nowrap;">
              Log In
            </a>
          {% endif %}
          {% if register_url %}
            <a href="{{ register_url }}" class="btn btn-outline-primary rounded-pill px-3 font-weight-bold" style="white-space:nowrap;">
              Join Now
            </a>
          {% endif %}
        {% endif %}

        <button class="navbar-toggler ml-3 d-lg-none border-0" type="button"
                data-toggle="collapse" data-target="#s4lMobileMenu" aria-controls="s4lMobileMenu">
          <i class="fa fa-bars fa-lg text-dark"></i>
        </button>

      </div>
    </div>
  </div>

  <!-- MOBILE MENU -->
  <div class="collapse d-lg-none bg-white border-top" id="s4lMobileMenu">
    <div class="container py-3">

      {% if user.is_authenticated and user.is_recipient %}
        <a href="{{ recipient_request_url }}" class="btn btn-danger btn-block mb-3">
          <i class="fa fa-tint mr-2"></i>Request Blood
        </a>
      {% else %}
        <a href="{{ emergency_request_url }}" class="btn btn-danger btn-block mb-3">
          <i class="fa fa-tint mr-2"></i>Request Blood
        </a>
      {% endif %}

      <a href="{{ blood_feed_url }}" class="d-block py-2 text-dark border-bottom">Find Blood</a>
      <a href="{{ blood_campaigns_url }}" class="d-block py-2 text-dark border-bottom">Donation Camps</a>
      <a href="{{ campaign_list_url|default:'#' }}" class="d-block py-2 text-dark border-bottom">Crowdfunding</a>

      {# Organ links #}
      {% if user.is_authenticated %}
        {% if user.is_donor and organ_pledge_list_url %}
          <a href="{{ organ_pledge_list_url }}" class="d-block py-2 text-dark border-bottom">Organ Pledges</a>
        {% elif user.is_recipient and organ_request_list_url %}
          <a href="{{ organ_request_list_url }}" class="d-block py-2 text-dark border-bottom">Organ Requests</a>
        {% elif organ_pledge_create_url %}
          <a href="{{ organ_pledge_create_url }}" class="d-block py-2 text-dark border-bottom">Organ</a>
        {% endif %}
      {% else %}
        <a href="{{ login_url }}" class="d-block py-2 text-dark border-bottom">Organ</a>
      {% endif %}

      {% if user.is_authenticated %}
        {% if org_membership %}
          <a href="{{ org_portal_url }}" class="d-block py-2 text-dark border-bottom">Institutions</a>
          {% if organ_portal_url %}
            <a href="{{ organ_portal_url }}" class="d-block py-2 text-dark border-bottom">Organ Portal</a>
          {% endif %}
        {% elif org_application %}
          <a href="{{ org_pending_url }}" class="d-block py-2 text-dark border-bottom">Institutions</a>
        {% else %}
          <a href="{{ org_register_url }}" class="d-block py-2 text-dark border-bottom">Institutions</a>
        {% endif %}
      {% else %}
        <a href="{{ institutions_home_url }}" class="d-block py-2 text-dark border-bottom">Institutions</a>
      {% endif %}

      {% url 'about' as about_url %}
      <a href="{{ about_url|default:'#' }}" class="d-block py-2 text-dark border-bottom">About</a>

      {% if user.is_authenticated %}
        {% if profile_url %}<a href="{{ profile_url }}" class="d-block py-2 text-dark border-bottom">Profile</a>{% endif %}
        {% if user.is_recipient %}<a href="{{ my_requests_url }}" class="d-block py-2 text-dark border-bottom">My Blood Requests</a>{% endif %}
        {% if user.is_donor %}<a href="{{ donor_history_url }}" class="d-block py-2 text-dark border-bottom">Donation History</a>{% endif %}

        {% if my_donations_url %}
          <a href="{{ my_donations_url }}" class="d-block py-2 text-dark border-bottom">
            My Contributions
          </a>
        {% endif %}

        {% if inbox_url %}
          <a href="{{ inbox_url }}" class="d-flex justify-content-between align-items-center py-2 text-dark border-bottom">
            <span>Notifications</span>
            {% if unread_notifications_count|default:0 %}
              <span class="badge badge-danger" style="border-radius:999px; min-width:22px;">
                {{ unread_notifications_count }}
              </span>
            {% endif %}
          </a>
        {% endif %}

        {% if kyc_submit_url %}<a href="{{ kyc_submit_url }}" class="d-block py-2 text-dark border-bottom">KYC</a>{% endif %}
        {% if logout_url %}<a href="{{ logout_url }}" class="d-block py-2 text-danger font-weight-bold">Logout</a>{% endif %}
      {% else %}
        {% if login_url %}<a href="{{ login_url }}" class="btn btn-outline-primary btn-block mt-3">Log In</a>{% endif %}
        {% if register_url %}<a href="{{ register_url }}" class="btn btn-primary btn-block mt-2">Join Now</a>{% endif %}
      {% endif %}
    </div>
  </div>
</header>

<style>
  body { padding-top: 0 !important; }
  .s4l-topbar { background: var(--primary-color); color: #fff; font-size: 14px; }
  .s4l-topbar .container { padding-top: 6px; padding-bottom: 6px; }
  .s4l-toplink { color:#fff; text-decoration:none; font-weight:700; font-size:14px; }
  .s4l-toplink:hover { text-decoration: underline; color:#fff; }

  .s4l-navbar { position: sticky; top: 0; z-index: 1000; }
  .s4l-logo{
  height: 56px;
  max-height: 56px;

  width: auto;
  max-width: 180px;      /* This helps in preventing overlapping */
  object-fit: contain;
  display: block;
}

@media (max-width: 1199.98px){
  .s4l-logo{ max-width: 160px; }
}
@media (max-width: 991.98px){
  .s4l-logo{
    height: 48px;
    max-height: 48px;
    max-width: 150px;
  }
}
@media (max-width: 575.98px){
  .s4l-logo{
    height: 42px;
    max-height: 42px;
    max-width: 130px;
  }
}

  .s4l-navbar .col-lg-3{ overflow: hidden; } /* this helps us to ensure that logo doesn't overflow on smaller screens */

  .s4l-brand-text { font-weight: 900; color: var(--primary-color); letter-spacing: -1px; }

  /* keep menu clickable even if right side overlaps */
  .s4l-center-col { position: relative; z-index: 3; }
  .s4l-menu { position: relative; z-index: 3; }
  .s4l-right-col { position: relative; z-index: 2; }

  /* Shift right items a bit left on desktop */
  @media (min-width: 992px){
    .s4l-right-col { padding-right: 26px; }
  }

  .s4l-menu .nav-link { color:#444; font-weight:700; font-size:15px; padding:0.35rem 0.9rem; }
  .s4l-menu .nav-link:hover { color: var(--primary-color); }
  .s4l-menu { flex-wrap: nowrap; }
  .s4l-menu .nav-link { white-space: nowrap; }

  .s4l-avatar { width:36px; height:36px; border-radius:999px; object-fit:cover; border:2px solid #e9ecef; }
  .s4l-avatar-fallback { width:36px; height:36px; border-radius:999px; background:#f1f3f5; color:var(--primary-color); display:flex; align-items:center; justify-content:center; border:2px solid #e9ecef; }

  .s4l-user-toggle { position: relative; }
  .s4l-notif-dot {
    position: absolute;
    top: -2px;
    left: 26px;
    width: 10px;
    height: 10px;
    background: var(--secondary-color);
    border-radius: 999px;
    border: 2px solid #fff;
  }

  .s4l-btn-pulse { position: relative; }
  .s4l-btn-pulse::after{
    content:"";
    position:absolute;
    inset:-6px;
    border-radius:999px;
    border:2px solid rgba(230,57,70,0.35);
    animation: s4lPulse 1.8s infinite;

    /* do not steal clicks from About/other links */
    pointer-events: none;
  }
  @keyframes s4lPulse {
    0% { transform: scale(0.92); opacity: 1; }
    70% { transform: scale(1.12); opacity: 0; }
    100% { transform: scale(1.12); opacity: 0; }
  }
</style>