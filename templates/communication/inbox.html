{% extends "master/base.html" %}
{% block content %}

<section class="section-content padding-y" style="min-height:84vh; padding-top:22px;">
  <div class="container" style="max-width: 980px;">

    <!-- Header -->
    <div class="d-flex flex-column flex-lg-row justify-content-between align-items-lg-center mb-3">
      <div class="mb-2 mb-lg-0">
        <h3 class="mb-1">Notifications</h3>
        <div class="text-muted">
          Showing last {{ cutoff_days|default:"7" }} days.
          <span class="ml-2 text-muted small" id="s4l-counts"></span>
        </div>
      </div>

      <div class="d-flex flex-wrap align-items-center" style="gap: .5rem;">
        <form method="post" action="{% url 'notification_read_all' %}" class="m-0">
          {% csrf_token %}
          <button type="submit" class="btn btn-outline-primary">
            <i class="fa fa-check mr-1"></i> Mark all as read
          </button>
        </form>

        <form method="post" action="{% url 'notification_clear_all' %}" class="m-0"
              onsubmit="return confirm('Clear ALL notifications? This cannot be undone.');">
          {% csrf_token %}
          <button type="submit" class="btn btn-outline-danger">
            <i class="fa fa-trash mr-1"></i> Clear all
          </button>
        </form>
      </div>
    </div>

    <!-- Filters + Search -->
    <div class="card shadow-sm mb-3">
      <div class="card-body py-3">
        <div class="row align-items-center">
          <div class="col-lg-6 mb-2 mb-lg-0">
            <div class="input-group">
              <div class="input-group-prepend">
                <span class="input-group-text bg-white"><i class="fa fa-search text-muted"></i></span>
              </div>
              <input id="s4lSearch" type="text" class="form-control"
                     placeholder="Search notifications (title/body)…" autocomplete="off">
            </div>
            <div class="text-muted small mt-1">
              Tip: search “match”, “pledge”, “verified”, “request”, etc.
            </div>
          </div>

          <div class="col-lg-6">
            <div class="d-flex flex-wrap justify-content-lg-end" style="gap:.5rem;">
              <button type="button" class="btn btn-sm btn-primary s4l-filter" data-filter="all">All</button>
              <button type="button" class="btn btn-sm btn-outline-secondary s4l-filter" data-filter="unread">Unread</button>
              <button type="button" class="btn btn-sm btn-outline-secondary s4l-filter" data-filter="read">Read</button>

              <div class="border-left d-none d-lg-block mx-1" style="height:28px;"></div>

              <button type="button" class="btn btn-sm btn-outline-secondary s4l-level" data-level="INFO">Info</button>
              <button type="button" class="btn btn-sm btn-outline-success s4l-level" data-level="SUCCESS">Success</button>
              <button type="button" class="btn btn-sm btn-outline-warning s4l-level" data-level="WARNING">Warning</button>
              <button type="button" class="btn btn-sm btn-outline-danger s4l-level" data-level="DANGER">Danger</button>

              <button type="button" class="btn btn-sm btn-outline-dark" id="s4lReset">
                Reset
              </button>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- List -->
    <div class="card shadow-sm">
      <div class="card-body p-0">

        {% if items %}
          <div class="list-group list-group-flush" id="s4lList">
            {% for n in items %}
              <div class="list-group-item s4l-item"
                   data-read="{% if n.read_at %}1{% else %}0{% endif %}"
                   data-level="{{ n.level|default:'INFO' }}"
                   data-text="{{ n.title|default:'' }} {{ n.body|default:'' }}">

                <div class="d-flex flex-column flex-md-row justify-content-between align-items-start">
                  <!-- LEFT -->
                  <div class="pr-md-3" style="min-width:0;">
                    <div class="d-flex flex-wrap align-items-center mb-1" style="gap:.45rem;">
                      {% if not n.read_at %}
                        <span class="badge badge-danger">New</span>
                      {% endif %}

                      {% if n.level == "SUCCESS" %}
                        <span class="badge badge-success">Success</span>
                      {% elif n.level == "WARNING" %}
                        <span class="badge badge-warning">Warning</span>
                      {% elif n.level == "DANGER" %}
                        <span class="badge badge-danger">Danger</span>
                      {% else %}
                        <span class="badge badge-secondary">Info</span>
                      {% endif %}

                      <div class="font-weight-bold" style="font-size:18px; line-height:1.2;">
                        {{ n.title }}
                      </div>
                    </div>

                    {% if n.body %}
                      <div class="text-muted small s4l-body-wrap">
                        <div class="s4l-body s4l-collapsed" id="body-{{ n.id }}">
                          {{ n.body }}
                        </div>
                        <button type="button" class="btn btn-link btn-sm p-0 s4l-readmore" data-target="body-{{ n.id }}">
                          Read more
                        </button>
                      </div>
                    {% endif %}

                    <div class="text-muted small mt-2">
                      <i class="fa fa-clock mr-1"></i> {{ n.created_at|timesince }} ago
                      {% if n.read_at %}
                        • Read
                      {% else %}
                        • Unread
                      {% endif %}
                    </div>
                  </div>

                  <!-- RIGHT -->
                  <div class="mt-3 mt-md-0 ml-md-3 w-100 w-md-auto">
                    <div class="d-flex flex-column flex-sm-row justify-content-md-end align-items-stretch"
                         style="gap:.5rem;">
                      {% if n.url %}
                        <a href="{% url 'notification_open' n.id %}" class="btn btn-sm btn-primary s4l-action-btn">
                          Open
                        </a>
                      {% endif %}

                      {% if not n.read_at %}
                        <a href="{% url 'notification_read' n.id %}" class="btn btn-sm btn-outline-secondary s4l-action-btn">
                          Mark read
                        </a>
                      {% endif %}
                    </div>
                  </div>
                </div>

              </div>
            {% endfor %}
          </div>

          <div class="p-3 text-muted small border-top d-none" id="s4lEmpty">
            No notifications match your filters.
          </div>

        {% else %}
          <div class="p-4 text-center text-muted">
            No notifications found.
          </div>
        {% endif %}

      </div>
    </div>

  </div>
</section>

<style>
  /* Make action buttons visually consistent */
  .s4l-action-btn{
    min-width: 110px;
  }

  /* Collapsible body (2-line clamp) */
  .s4l-body{
    white-space: normal;
    word-break: break-word;
  }
  .s4l-collapsed{
    display: -webkit-box;
    -webkit-line-clamp: 2;
    -webkit-box-orient: vertical;
    overflow: hidden;
  }
  .s4l-body-wrap .s4l-readmore{
    text-decoration: none;
  }
  .s4l-body-wrap .s4l-readmore:focus{
    outline: none;
    box-shadow: none;
  }
</style>

<script>
(function(){
  function q(sel, root){ return (root || document).querySelector(sel); }
  function qa(sel, root){ return Array.from((root || document).querySelectorAll(sel)); }

  const list = q("#s4lList");
  if (!list) return;

  const items = qa(".s4l-item", list);
  const searchEl = q("#s4lSearch");
  const emptyEl = q("#s4lEmpty");
  const countsEl = q("#s4l-counts");

  let filterRead = "all";   // all | unread | read
  let filterLevel = null;   // null or INFO/SUCCESS/WARNING/DANGER

  function normalize(s){
    return (s || "").toString().toLowerCase().trim();
  }

  function apply(){
    const term = normalize(searchEl.value);
    let visible = 0;
    let unreadVisible = 0;
    let totalUnread = 0;

    items.forEach(function(el){
      const isRead = el.getAttribute("data-read") === "1";
      const level = (el.getAttribute("data-level") || "INFO").toUpperCase();
      const text = normalize(el.getAttribute("data-text") || "");

      if (!isRead) totalUnread++;

      let ok = true;

      if (filterRead === "unread" && isRead) ok = false;
      if (filterRead === "read" && !isRead) ok = false;

      if (filterLevel && level !== filterLevel) ok = false;

      if (term && text.indexOf(term) === -1) ok = false;

      el.style.display = ok ? "" : "none";

      if (ok){
        visible++;
        if (!isRead) unreadVisible++;
      }
    });

    if (emptyEl){
      emptyEl.classList.toggle("d-none", visible !== 0);
    }
    if (countsEl){
      countsEl.textContent = `• Showing ${visible}/${items.length} • Unread ${unreadVisible} (Total unread: ${totalUnread})`;
    }
  }

  // Read more / show less toggles
  qa(".s4l-readmore").forEach(function(btn){
    btn.addEventListener("click", function(){
      const id = btn.getAttribute("data-target");
      const body = document.getElementById(id);
      if (!body) return;

      const collapsed = body.classList.contains("s4l-collapsed");
      if (collapsed){
        body.classList.remove("s4l-collapsed");
        btn.textContent = "Show less";
      } else {
        body.classList.add("s4l-collapsed");
        btn.textContent = "Read more";
      }
    });
  });

  // Hide readmore button if body is short
  qa(".s4l-body-wrap").forEach(function(wrap){
    const body = q(".s4l-body", wrap);
    const btn = q(".s4l-readmore", wrap);
    if (!body || !btn) return;

    // Rough check: if very short, no need "read more"
    const txt = (body.textContent || "").trim();
    if (txt.length < 160){
      btn.style.display = "none";
      body.classList.remove("s4l-collapsed");
    }
  });

  // Search
  if (searchEl){
    searchEl.addEventListener("input", apply);
  }

  // Filters
  qa(".s4l-filter").forEach(function(b){
    b.addEventListener("click", function(){
      filterRead = b.getAttribute("data-filter") || "all";

      // button styles
      qa(".s4l-filter").forEach(function(x){
        x.classList.remove("btn-primary");
        x.classList.add("btn-outline-secondary");
      });
      b.classList.remove("btn-outline-secondary");
      b.classList.add("btn-primary");

      apply();
    });
  });

  // Level filters
  qa(".s4l-level").forEach(function(b){
    b.addEventListener("click", function(){
      const level = (b.getAttribute("data-level") || "").toUpperCase();
      if (filterLevel === level){
        filterLevel = null;
        b.classList.remove("btn-dark");
      } else {
        filterLevel = level;
        qa(".s4l-level").forEach(function(x){ x.classList.remove("btn-dark"); });
        b.classList.add("btn-dark");
      }
      apply();
    });
  });

  // Reset
  const resetBtn = q("#s4lReset");
  if (resetBtn){
    resetBtn.addEventListener("click", function(){
      filterRead = "all";
      filterLevel = null;
      if (searchEl) searchEl.value = "";

      // reset styles
      qa(".s4l-filter").forEach(function(x){
        x.classList.remove("btn-primary");
        x.classList.add("btn-outline-secondary");
      });
      const allBtn = q('.s4l-filter[data-filter="all"]');
      if (allBtn){
        allBtn.classList.remove("btn-outline-secondary");
        allBtn.classList.add("btn-primary");
      }
      qa(".s4l-level").forEach(function(x){ x.classList.remove("btn-dark"); });

      apply();
    });
  }

  // initial
  apply();
})();
</script>

{% endblock %}