{% extends "master/base.html" %}
{% load static %}

{% block content %}

{# Safe URL variables (won't crash if a URL name is missing) #}
{% url 'login' as login_url %}
{% url 'register' as register_url %}
{% url 'profile' as profile_url %}
{% url 'kyc_submit' as kyc_submit_url %}
{% url 'family_add' as family_add_url %}

<!-- ========================= 1. HERO SECTION (SEARCH & ACTION) ========================= -->
<section class="section-intro padding-y-lg text-white"
  style="background: linear-gradient(rgba(10, 37, 88, 0.9), rgba(10, 37, 88, 0.8)),
         url('{% if site_settings and site_settings.hero_background %}{{ site_settings.hero_background.url }}{% else %}{% static "images/hospital-bg.jpg" %}{% endif %}')
         center/cover no-repeat;
         min-height: 520px; display: flex; align-items: center;">

  <div class="container">
    <div class="row align-items-center">

      <div class="col-md-7">
        <span class="badge badge-danger text-uppercase px-3 py-2 mb-3 shadow">
          Saving Lives, Together
        </span>

        <h1 class="display-4 font-weight-bold mb-3">
          {{ site_settings.hero_title|default:"Every Drop Counts, Every Penny Helps."|linebreaksbr }}
        </h1>

        <p class="lead mb-4" style="opacity: 0.9;">
          {{ site_settings.hero_subtitle|default:"The integrated platform for Blood Donation, Organ Pledging, and Medical Crowdfunding. Find donors nearby in seconds." }}
        </p>

        <!-- Access KYC/Profile from homepage -->
        <div class="mb-4">
          {% if request.user.is_authenticated %}
            {% if profile_url %}
              <a href="{{ profile_url }}" class="btn btn-light font-weight-bold mr-2">
                <i class="fa fa-user"></i> My Profile
              </a>
            {% endif %}

            {% if kyc_submit_url and not request.user.is_verified %}
              <a href="{{ kyc_submit_url }}" class="btn btn-danger font-weight-bold mr-2">
                <i class="fa fa-id-card"></i> Get Verified (KYC)
              </a>
            {% endif %}

            {% if family_add_url %}
              <a href="{{ family_add_url }}" class="btn btn-outline-light font-weight-bold">
                <i class="fa fa-users"></i> Add Family
              </a>
            {% endif %}
          {% else %}
            {% if login_url %}
              <a href="{{ login_url }}" class="btn btn-light font-weight-bold mr-2">
                <i class="fa fa-sign-in-alt"></i> Login
              </a>
            {% endif %}
            {% if register_url %}
              <a href="{{ register_url }}" class="btn btn-danger font-weight-bold">
                <i class="fa fa-user-plus"></i> Create Account
              </a>
            {% endif %}
          {% endif %}
        </div>

        <!-- Main Search Widget (UI only for now) -->
        <div class="bg-white p-2 rounded shadow-lg d-inline-block w-100" style="max-width: 600px;">
          <form action="#" method="GET" class="row no-gutters">
            <div class="col-md-4">
              <select class="form-control border-0 custom-select-lg" style="height: 50px;">
                <option selected>Blood Group</option>
                <option>A+</option><option>A-</option>
                <option>B+</option><option>B-</option>
                <option>AB+</option><option>AB-</option>
                <option>O+</option><option>O-</option>
              </select>
            </div>
            <div class="col-md-5 border-left">
              <input type="text" class="form-control border-0"
                     placeholder="Enter City or Area" style="height: 50px; padding-left: 20px;">
            </div>
            <div class="col-md-3">
              <button type="submit" class="btn btn-danger btn-block h-100 font-weight-bold" style="border-radius: 5px;">
                <i class="fa fa-search"></i> Find
              </button>
            </div>
          </form>
        </div>
      </div>

      <div class="col-md-5 text-center d-none d-md-block">
        <img src="{% static 'images/hero-vector.svg' %}" alt="Share4Life" class="img-fluid" style="opacity: 0.9;">
      </div>

    </div>
  </div>
</section>

<!-- ========================= 2. LIVE URGENT TICKER (dynamic) ========================= -->
<div class="bg-danger text-white py-2 shadow-sm">
  <div class="container d-flex align-items-center">
    <span class="badge badge-light text-danger mr-3 font-weight-bold">URGENT NEEDS:</span>

    <marquee behavior="scroll" direction="left" scrollamount="6">
      {% for r in urgent_requests %}
        <span class="mr-5">
          <i class="fa fa-tint"></i> {{ r.blood_group }} Blood needed
          {% if r.hospital_name %} at {{ r.hospital_name }}{% endif %}
          {% if r.city %} ({{ r.city }}){% endif %}
        </span>
      {% empty %}
        <span class="mr-5"><i class="fa fa-check-circle"></i> No urgent requests right now.</span>
      {% endfor %}
    </marquee>
  </div>
</div>

<!-- ========================= 3. THREE PILLARS (FEATURES) ========================= -->
<section class="section-features padding-y bg-light">
  <div class="container">
    <div class="text-center mb-5">
      <h2 class="font-weight-bold" style="color: #0A2558;">How You Can Help</h2>
      <p class="text-muted">Choose a category to start making an impact</p>
    </div>

    <div class="row">
      <div class="col-md-4">
        <div class="card card-hover border-0 shadow-sm mb-4">
          <div class="card-body text-center p-4">
            <div class="icon-box mb-3 mx-auto text-danger rounded-circle d-flex align-items-center justify-content-center"
                 style="width: 70px; height: 70px; font-size: 28px; background-color: #fde8e9;">
              <i class="fa fa-heartbeat"></i>
            </div>
            <h5 class="font-weight-bold">Donate Blood</h5>
            <p class="text-muted">Find nearby emergency requests using GPS. Be a hero in real-time.</p>
            <a href="#" class="btn btn-outline-danger btn-sm rounded-pill px-4">Find Requests</a>
          </div>
        </div>
      </div>

      <div class="col-md-4">
        <div class="card card-hover border-0 shadow-sm mb-4">
          <div class="card-body text-center p-4">
            <div class="icon-box mb-3 mx-auto text-primary rounded-circle d-flex align-items-center justify-content-center"
                 style="width: 70px; height: 70px; font-size: 28px; background-color: #e8f0fe;">
              <i class="fa fa-file-medical"></i>
            </div>
            <h5 class="font-weight-bold">Pledge Organs</h5>
            <p class="text-muted">Securely sign legal consent forms and leave a lasting legacy.</p>
            <a href="#" class="btn btn-outline-primary btn-sm rounded-pill px-4">Pledge Now</a>
          </div>
        </div>
      </div>

      <div class="col-md-4">
        <div class="card card-hover border-0 shadow-sm mb-4">
          <div class="card-body text-center p-4">
            <div class="icon-box mb-3 mx-auto text-success rounded-circle d-flex align-items-center justify-content-center"
                 style="width: 70px; height: 70px; font-size: 28px; background-color: #e0f2f1;">
              <i class="fa fa-hand-holding-heart"></i>
            </div>
            <h5 class="font-weight-bold">Medical Funds</h5>
            <p class="text-muted">Support verified patients who cannot afford critical surgeries.</p>
            <a href="#" class="btn btn-outline-success btn-sm rounded-pill px-4">Donate Money</a>
          </div>
        </div>
      </div>
    </div>
  </div>
</section>

<!-- ========================= 4. URGENT REQUESTS GRID (dynamic) ========================= -->
<section class="section-requests padding-y">
  <div class="container">
    <div class="d-flex justify-content-between align-items-center mb-4">
      <h3 class="font-weight-bold" style="color: #0A2558;">Active Emergencies</h3>
      <a href="#" class="text-danger font-weight-bold">View All <i class="fa fa-arrow-right"></i></a>
    </div>

    <div class="row">
      {% for r in recent_requests %}
        <div class="col-md-6 col-lg-3">
          <div class="card mb-3 border border-light shadow-sm h-100">
            <div class="card-body">
              <div class="d-flex justify-content-between mb-2">
                <span class="badge badge-danger">Urgent</span>
                <small class="text-muted"><i class="fa fa-clock"></i> {{ r.created_at|timesince }} ago</small>
              </div>

              <div class="d-flex align-items-center mb-3">
                <div class="display-4 font-weight-bold text-danger mr-3">{{ r.blood_group }}</div>
                <div style="line-height: 1.2;">
                  <strong>{{ r.patient_name|default:"Patient" }}</strong><br>
                  <small class="text-muted">{{ r.hospital_name|default:r.city|default:"Hospital" }}</small>
                </div>
              </div>

              <a href="#" class="btn btn-block btn-primary btn-sm">Contact Now</a>
            </div>
          </div>
        </div>
      {% empty %}
        <div class="col-12">
          <div class="alert alert-secondary">No active emergencies right now.</div>
        </div>
      {% endfor %}
    </div>
  </div>
</section>

<!-- ========================= 5. CROWDFUNDING HIGHLIGHT (dynamic) ========================= -->
<section class="section-fund padding-y bg-white border-top">
  <div class="container">
    {% if featured_campaign %}
      <div class="row align-items-center">
        <div class="col-md-6">
          {% if featured_campaign.image %}
            <img src="{{ featured_campaign.image.url }}" class="img-fluid rounded shadow" alt="Campaign">
          {% else %}
            <img src="https://via.placeholder.com/600x400" class="img-fluid rounded shadow" alt="Campaign">
          {% endif %}
        </div>

        <div class="col-md-6 pl-md-5">
          <h5 class="text-danger font-weight-bold mb-2">CAMPAIGN OF THE MONTH</h5>
          <h3>{{ featured_campaign.title|default:"Featured Campaign" }}</h3>
          <p class="text-muted">{{ featured_campaign.story|default:""|truncatechars:180 }}</p>

          <div class="progress mb-2" style="height: 10px;">
            <div class="progress-bar bg-success" role="progressbar" style="width: 50%;"></div>
          </div>

          <button class="btn btn-danger btn-lg rounded-pill shadow">
            Donate Now <i class="fa fa-heart ml-1"></i>
          </button>
        </div>
      </div>
    {% else %}
      <div class="text-center text-muted">No featured campaign right now.</div>
    {% endif %}
  </div>
</section>

<style>
  .card-hover { transition: transform 0.3s ease, box-shadow 0.3s ease; }
  .card-hover:hover { transform: translateY(-5px); box-shadow: 0 10px 20px rgba(0,0,0,0.1) !important; }
  .custom-select-lg { font-size: 16px; color: #495057; }
  .btn-primary { background: linear-gradient(135deg, #0a2558 0%, #061838 100%); border: none; }
</style>

{% endblock %}